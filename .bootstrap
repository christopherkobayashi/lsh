#! /bin/sh

# Build all automatically generated files that are not present in the
# CVS repository.

# This script is for use in the source directory, before you run
# configure. To get started from a fresh CVS checkout, you also need
# to run configure and make bootstrap from your build directory.

set -e

relative_symlink() {
    (
	target="$1"
	shift
	while [ $# -ge 1 ] ; do
	    dir="$1"
	    if [ "$dir" = "." ] ; then
		ln -s "$target" "$dir"
	    else
		dotdots="`echo "$dir" | sed 's%[^/][^/]*%..%g'`"
		(cd "$dir" && ln -s "$dotdots/$target" . || true)
	    fi
	    shift
	done
    )
}

relative_symlink misc/run-tests \
    argp/testsuite nettle/testsuite nettle/examples \
    spki/testsuite sftp/testsuite src/testsuite

relative_symlink aclocal.m4 \
    argp nettle spki sftp

relative_symlink misc/vsnprintf.c \
    argp sftp
    
relative_symlink misc/getopt.c \
    src/testsuite nettle/examples nettle/tools spki/tools
relative_symlink misc/getopt1.c \
    src/testsuite nettle/examples nettle/tools spki/tools
relative_symlink misc/getopt.h \
    src/testsuite nettle/examples nettle/tools spki/tools

relative_symlink config.guess nettle spki
relative_symlink config.sub nettle spki

relative_symlink install-sh argp nettle spki sftp
relative_symlink texinfo.tex nettle

relative_symlink INSTALL nettle spki

if [ "$1" = "links" ] ; then
    # Skip the time consuming autoconf stuff
    exit 0;
fi

for subdir in argp nettle spki sftp; do
    (cd $subdir && ./.bootstrap)
done

autoconf && autoheader
